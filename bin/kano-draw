#!/usr/bin/env python

# kano-draw
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
# The Draw App implementation
#

import os
import subprocess
import time
import errno
import atexit

from kano.webapp import WebApp

app_name = 'kano-draw'
server_pid = None


class Draw(WebApp):
    def __init__(self):
        self._index = "http://localhost:8000"
        self._title = "Draw with code"

        self._decoration = False
        self._maximized = True

        self._home_dir = os.path.expanduser('~')
        self._save_dir = self._home_dir + '/Draw-content/'
        self._parent_dir = '..'

        self._mkdir_p(self._save_dir)

    def _mkdir_p(self, path):
        try:
            os.makedirs(path)
        except OSError as exc:
            if exc.errno == errno.EEXIST and os.path.isdir(path):
                pass
            else:
                raise

def start_server():
    global server_pid

    # Initialise the local server
    # TODO: this is not the most eficient way to initialise the server
    server_proc = subprocess.Popen(['python', '-m', 'SimpleHTTPServer'])
    server_pid = server_proc.pid

    # Wait for the server to be up
    time.sleep(2)

def stop_server():
    os.system('kill {}'.format(server_pid))


start_server()
atexit.register(stop_server)

# Init the web app
draw = Draw()
draw.run()
