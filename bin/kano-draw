#!/usr/bin/env python

# kano-draw
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
# The Draw App implementation
#

import os
import sys
import subprocess
import time
import errno
import atexit

from kano.webapp import WebApp

app_name = 'kano-draw'


class Draw(WebApp):
    def __init__(self):
        self._index = "http://localhost:8000"
        self._title = "Draw with code"

        self._decoration = False
        self._maximized = True

        self._home_dir = os.path.expanduser('~')
        self._save_dir = self._home_dir + '/Draw-content/'
        self._parent_dir = '..'

        self._mkdir_p(self._save_dir)

    def _mkdir_p(self, path):
        try:
            os.makedirs(path)
        except OSError as exc:
            if exc.errno == errno.EEXIST and os.path.isdir(path):
                pass
            else:
                raise


class Server(object):
    _server_pid = None

    def __init__(self):
        atexit.register(self.stop)

    def _get_root_dir(self):
        bin_path = os.path.abspath(os.path.dirname(__file__))

        if bin_path.startswith('/usr'):
            return '/usr/share/kano-draw'
        else:
            return os.path.join(bin_path, '../www')

    def start(self):
        # TODO: this is not the most eficient way to initialise the server

        os.chdir(self._get_root_dir())
        server_proc = subprocess.Popen(['python', '-m', 'SimpleHTTPServer'])
        self._server_pid = server_proc.pid

        # Wait for the server to be up
        time.sleep(2)

    def stop(self):
        os.system('kill {}'.format(self._server_pid))

# Initialise the local server
server = Server()
server.start()

# Init the web app
draw = Draw()
draw.run()
